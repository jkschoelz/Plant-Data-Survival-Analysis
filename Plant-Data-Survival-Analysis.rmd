---
title: "Bayesian plant survival analysis"
author: "Kevin Schoelz"
date: "May 2019"
output: html_document

---


```{r setup, include=FALSE}

# Clear the environment
rm(list = ls())
gc(reset = TRUE)

# Notebook Settings
knitr::opts_chunk$set(echo = TRUE)


```


In this notebook, we are looking how genotype of a given plant species will affect the plant resistance to disease. To do this we have data from the following experiment.

Plants are of different genotypes are prepared. The plants are then all inoculated with the virus at the same time. Plants are observed once each day to see if symptoms have developed. The result is that we have a dataset with each plant labeled with an id, genotype, and when the plant developed local symptoms, and when it became generally symptomatic. There are several types of genotypes, and the experiment is repeated at different times of the year over a five year period.

To begin the analysis, we load some useful libraries.

```{r load_libraries}

library(tidyverse)
library(rstan)
library(cowplot)
library(fastDummies)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

#ggplot2 settings
theme_set(theme_cowplot())

```

## Importing and visualizing data

We can start by importing the data. From previous notebook, the data has already been organized into a tidy format. 

```{r read-and-import-data}

df <- read.csv("unpacked_plant_data.csv")

# Take the Ecotype Variable and separate it out into covariate columns
df <- dummy_columns(df, select_columns = c("Ecotype", "Trial.Name"))

head(df)

## Plot histograms of failure times for uncensored data
ggplot(data = df %>% filter(Censored==0), aes(x= First.Infection, fill = Ecotype, alpha = 0.5)) +
  geom_histogram(color = "Black", binwidth = 1, position = "stack")
```


## Building the first model.

Let the failure time for the $i\text{th}$ plant of genotype $g$ be $y_{ig}$. We will model these separately for now. We assume

$$
y_{ig} \sim \mathcal{W}(\alpha_{g}, \lambda_{g})
$$

Let's build a Stan model to fit the data.

```{r}

# set up the data

uncensored_df <- df %>% filter(Censored==0, Ecotype == "XI-2")

y <- uncensored_df$First.Infection

Ecotype_Cols <- data.frame( X = colnames(uncensored_df)) %>% filter(startsWith(as.character(X), "Ecotype_"))

X <- uncensored_df %>% select(6:11)
X <- as.matrix(X)
N <- length(y)

data = list(y = y,
            X = X,
            M = dim(X)[2],
            N = dim(X)[1])

fit <- stan(file = "fit_weibull_completepooling.stan",
            data = data,
            iter = 1000,
            chains = 4)


```


```{r}

summary_fit <- as.data.frame(summary(fit))

summary_fit$row.number <- seq(1:nrow(summary_fit))



ggplot(data = summary_fit, aes(x = row.number, y=summary.mean, ymin = summary.25., ymax=summary.75.)) +
  geom_errorbar() +
  geom_point() +
  ylim(-5,15)

```








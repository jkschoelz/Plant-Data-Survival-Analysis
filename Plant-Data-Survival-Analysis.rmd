---
title: "Bayesian plant survival analysis"
author: "Kevin Schoelz"
date: "May 2019"
output:
  tufte::tufte_html:
    toc: true
    toc_depth: 1

---


```{r setup, include=FALSE}

# Clear the environment
rm(list = ls())
gc(reset = TRUE)

# Notebook Settings
knitr::opts_chunk$set(
  include = TRUE,
  cache = TRUE,
  collapse = TRUE,
  echo = TRUE,
  message = FALSE,
  tidy = FALSE,
  warning = FALSE,
  comment = "  ",
  dev = "png",
  dev.args = list(bg = '#FFFFF8'),
  dpi = 300,
  fig.align = "center",
  #fig.width = 7,
  #fig.asp = 0.618,
  fig.show = "hold",
  out.width = "90%"
)


```


In this notebook, we are looking how genotype of a given plant species will affect the plant resistance to disease. To do this we have data from the following experiment.

Plants are of different genotypes are prepared. The plants are then all inoculated with the virus at the same time. Plants are observed once each day to see if symptoms have developed. The result is that we have a dataset with each plant labeled with an id, genotype, and when the plant developed local symptoms, and when it became generally symptomatic. There are several types of genotypes, and the experiment is repeated at different times of the year over a five year period.

To begin the analysis, we load some useful libraries.

```{r load_libraries}

library(tidyverse)
library(rstan)
library(foreach)
library(doParallel)
library(tufte)
library(bayesplot)
library(cowplot)
library(stringr)
library(readxl)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

#ggplot2 settings
theme_set(theme_cowplot())

```

## Importing and visualizing data

```{r read-and-import-data}

df <- read_excel("Plant-Data-Clean.xlsx", sheet = "Tidydata")

head(df)

# plot raw data

## Plot histograms of censored vs uncensored data
#ggplot(data <- df)

## Plot histograms of failure times for uncensored data
ggplot(data = df %>% filter(Censored==0), aes(x= Failure.Date)) +
  geom_histogram(color = "Black", fill = "DodgerBlue4") +
  facet_wrap(~Genotype)
```


## Building the first model.

Let the failure time for the $i\text{th}$ plant of genotype $g$ be $y_{ig}$. We will model these separately for now. We assume

$$
y_{ig} \sim \mathcal{W}(\alpha_{g}, \lambda_{g})
$$

Let's build a Stan model to fit the data.

```{r}

# set up the data

uncensored_df <- df %>% filter(Censored==0, Genotype == "XI-2")

y = uncensored_df$Failure.Date
N = length(y)

data = list(y=y,
            N=N)

fit <- stan(file = "fit_weibull_model01.stan",
            data = data,
            iter = 1000,
            chains = 4)

pairs(fit)
```

```{r}

summary(fit)

```




---
title: "Plant Data"
subtitle: "01 Initial visualization and cleaning"
author: "Kevin Schoelz"
date: "August 2019"
output:
  tufte::tufte_html:
    toc: true
    toc_depth: 2
---

We have an experiment where we are looking at the behavior of different ecotypes of a certain species of plant. In the experiment, the plant are inoculated by a virus. They are then observed once a day for several days to see when virus symptoms become apparent. There is reason to believe that maybe some of the ecotypes can slow the infection of the plant. Eventually, we want to analyze the data to see if we can observe any effect in the time-to-event data. But first, we need to prep the data files for use.

Right now, the data is stored in the file `tidyplants.xlsx`. We need to get the data into a format that is easier to work with. We want the data to be in a tidy format, where rows of the dataset are individual observations, and columns are variables. This is a little general, and there are a couple ways of arranging our data in a tidy format. The first is to consider each plant to be it's own observation. Then variables for the plant will be the name of the trial, the ecotype and the day in which the plant first exhibited symptoms, and whether or not data from the plant was censored. We will store the tidy data organized in this way `tidyplants.csv`.

The second way we could arrange our data is to consider each day as an observation. Then, variables of interest would be the trial, ecotype, number of plants exhibiting symptoms, total number of plants of a given ecotype in the trial, total number of censored plants of a given ecotype in the trial. We will store data organized in thsis way in the file `tidyplants_cdf.csv`.

```{r setup, echo=FALSE, message=FALSE}

# Clear the environment
rm(list = ls())
#gc(reset = TRUE, verbose = FALSE)

# Notebook Settings
knitr::opts_chunk$set(echo = FALSE)

# Load Libraries
library(tidyverse)
library(tufte)
library(cowplot)
library(readxl)

#ggplot2 settings
theme_set(theme_cowplot())

```

# Importing the Data

Our data has been stored in an excel file, `tidyplants.xlsx`. This excel file has two sheets containing the data in which we are interested. The first sheet shows the cumulative number of infected plants on a given day by trial and  ecotype. The other is a summary table showing the total number of plants of a given ecotype in each trial, along with the end breakdown of how many were infected vs how many survived. We can use the `merge` function to combine these two data table into one larger dataframe. This table has been reproduced at the end of this notebook.

```{r load_data, message=FALSE, echo=FALSE}

# Load data and cache a csv snapshot of the excel files

# Load cdf data
tidyplants_cdf <- read_excel("Plant-Data-Messy-Format.xlsx", sheet = "tidyplants_cdf")%>%
  rename(day = Day,
         ecotype = Ecotype,
         trial_name = `Trial Name`,
         trial_index = `Trial Index`,
         trial_date = `Trial Date`,
         total_infections = `Total Infections`,
         new_infections = `New Infections`,
         Ntot = `Total Plants`,
         Nobs = `Total Observed`,
         Ncens = `Total Censored`,
         ycens = `Censored Day`, 
         XIK = `XI-K`,
         XI2 = `XI-2`,
         VIIIA = `VIII-A`,
         VIIIB = `VIII-B`,
         XIB = `XI-B`,
         XIA = `XI-A`) %>%
  mutate(trial_date = as.Date(trial_date))

tidyplants_cdf$ecotype <- factor(tidyplants_cdf$ecotype, levels = c("Col", 
                                                                    "XI-K",
                                                                    "XI-2",
                                                                    "VIII-A",
                                                                    "VIII-B",
                                                                    "XI-B",
                                                                    "XI-A",
                                                                    "CHUP",
                                                                    "CHUP/XI-2",
                                                                    "CHUP/XI-K",
                                                                    "XI-K/XI-2",
                                                                    "CHUP/XI-K/XI-2"))

head(tidyplants_cdf)

```

We can look at how the number of infected plants grows with time for each trial and ecotype using `ggplot`.


```{r cdf_vis, echo=FALSE}

cdf_plots <- ggplot(data = tidyplants_cdf, aes(x = day, y = total_infections)) +
  #geom_point(color = "DodgerBlue4") + 
  geom_step(color = "Black") +
  facet_grid(trial_date ~ ecotype) +
  xlab("Day") +
  ylab("Total Infections")

cdf_plots

ggsave("cdf_plots.pdf", plot = cdf_plots, height = 15, width = 15)
```

# Transforming data so that we track each individual plant

One of the questions we will be interested in looking at is how many new infections we observe on a given day. This will be helpful for some of the data analysis we will be conducting later. We have extracted this data and stored it in the dataframe below.

```{r data_reshaping, echo=FALSE}

# Start by constructing plant data for uncensored plants

trial_name <- c()
trial_index <- c()
trial_date <- c()
day <- c()
ecotype <- c()
XIK <- c()
XI2 <- c()
VIIIA <- c()
VIIIB <- c()
XIB <- c()
XIA <- c()
CHUP <- c()


for(i in 1:nrow(tidyplants_cdf %>% filter(day != 0))){
  trial_name <- c(trial_name, rep(tidyplants_cdf$trial_name[i], each = tidyplants_cdf$new_infections[i]) )
  trial_index <- c(trial_index, rep(tidyplants_cdf$trial_index[i], each = tidyplants_cdf$new_infections[i]) )
  str(tidyplants_cdf$trial_date[i])
  trial_date <- c(trial_index, rep(tidyplants_cdf$trial_date[i], each = tidyplants_cdf$new_infections[i]) )
  day <- c(day, rep(tidyplants_cdf$day[i], each = tidyplants_cdf$new_infections[i]) )
  ecotype <- c(ecotype, rep(as.character(tidyplants_cdf$ecotype[i]), each = tidyplants_cdf$new_infections[i]) )
  XIK <- c(XIK, rep(tidyplants_cdf$XIK[i], each = tidyplants_cdf$new_infections[i]) )
  XI2 <- c(XI2, rep(tidyplants_cdf$XI2[i], each = tidyplants_cdf$new_infections[i]) )
  VIIIA <- c(VIIIA, rep(tidyplants_cdf$VIIIA[i], each = tidyplants_cdf$new_infections[i]) )
  VIIIB <- c(VIIIB, rep(tidyplants_cdf$VIIIB[i], each = tidyplants_cdf$new_infections[i]) )
  XIB <- c(XIB, rep(tidyplants_cdf$XIB[i], each = tidyplants_cdf$new_infections[i]) )
  XIA <- c(XIA, rep(tidyplants_cdf$XIA[i], each = tidyplants_cdf$new_infections[i]) )
  CHUP <- c(CHUP, rep(tidyplants_cdf$CHUP[i], each = tidyplants_cdf$new_infections[i]) )
}

df_censored <- data.frame(trial_name = trial_name,
                          trial_index = trial_index,
                          trial_date = trial_date,
                          day = day,
                          ecotype = ecotype,
                          XIK = XIK,
                          XI2 = XI2,
                          VIIIA = VIIIA,
                          VIIIB = VIIIB,
                          XIB = XIB,
                          XIA = XIA,
                          CHUP = CHUP) %>% 
  mutate(censored = 0)

df_censored$ecotype <- factor(df_censored$ecotype, levels = c("Col", 
                                                              "XI-K",
                                                              "XI-2",
                                                              "VIII-A",
                                                              "VIII-B",
                                                              "XI-B",
                                                              "XI-A",
                                                              "CHUP",
                                                              "CHUP/XI-2",
                                                              "CHUP/XI-K",
                                                              "XI-K/XI-2",
                                                              "CHUP/XI-K/XI-2"))

head(df_censored,130)
```

```{r}

tp_hist <- ggplot(data = df_censored, aes(day)) +
  geom_histogram(color = "Black", fill = "DodgerBlue4", binwidth = 1) + 
  facet_grid(trial_date ~ ecotype)

tp_hist

ggsave("hist_plots.pdf", plot = tp_hist, height = 15, width = 15)
```

Now that we have our data exported out of the excel file and into `tidyplants.csv` and `tidyplants_cdf.csv` we can begin our analysis of the dataset.




# Dataframes

## `tidyplants_cdf.csv`

```{r tidyplants_cdf}

knitr::kable(tidyplants_cdf)

```

## `tidyplants.csv`

```{r tidyplants}

knitr::kable(tidyplants)

```
